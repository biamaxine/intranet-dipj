// This is your Prisma schema file,
// learn more about it in the Documents: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client"
  output          = "../generated/prisma"
  moduleFormat    = "cjs"
  previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
  provider = "postgresql"
}

model Department {
  id         String  @id @default(uuid()) @db.Uuid
  manager_id String? @unique @db.Uuid

  // Properties
  name        String  @unique @db.VarChar(60)
  acronym     String? @unique @db.VarChar(30)
  description String? @db.VarChar(500)
  email       String? @db.VarChar(255)
  phone       String? @db.VarChar(11)
  is_active   Boolean @default(true)

  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  deleted_at DateTime?

  // Relations
  users    User[]
  manager  User?                       @relation("Management", fields: [manager_id], references: [id])
  programs DepartmentProgramRelation[]

  @@map("Departments")
}

model User {
  id            String @id @default(uuid()) @db.Uuid
  department_id String @db.Uuid

  // Properties
  name        String  @db.VarChar(100)
  cpf         String  @unique @db.Char(11)
  email       String? @unique @db.VarChar(255)
  phone       String? @unique @db.VarChar(11)
  password    String  @db.VarChar(60) // Criptografia bcrypt
  is_active   Boolean @default(true)
  is_verified Boolean @default(false)

  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  deleted_at DateTime?

  // Relations
  programs   UserProgramRelation[]
  department Department                @relation(fields: [department_id], references: [id])
  management Department?               @relation("Management")
  documents  Document[]
  views      DocumentHistoryRelation[]

  @@index([name, is_active])
  @@map("Users")
}

model Program {
  id String @id @default(uuid()) @db.Uuid

  // Properties
  name        String  @unique @db.VarChar(60)
  link        String  @db.Text
  description String? @db.VarChar(500)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  departments DepartmentProgramRelation[]
  users       UserProgramRelation[]

  @@map("Programs")
}

model DepartmentProgramRelation {
  department_id String @db.Uuid
  program_id    String @db.Uuid

  // Relations
  department Department @relation(fields: [department_id], references: [id])
  program    Program    @relation(fields: [program_id], references: [id], onDelete: Cascade)

  @@id([department_id, program_id])
  @@map("DepartmentProgramRelations")
}

model UserProgramRelation {
  user_id    String @db.Uuid
  program_id String @db.Uuid

  // Relations
  user    User    @relation(fields: [user_id], references: [id])
  program Program @relation(fields: [program_id], references: [id], onDelete: Cascade)

  @@id([user_id, program_id])
  @@map("UserProgramsRelations")
}

enum DocumentStatus {
  PENDING
  OPENED
  WAITING
  COMPLETED
}

model Document {
  id          String  @id @default(uuid()) @db.Uuid
  user_id     String  @db.Uuid
  content_id  String? @unique @db.Uuid
  category_id String  @db.Uuid
  parent_id   String? @db.Uuid

  // Properties
  origin String @db.VarChar(122) // Delegacia de Origem
  state  String @db.Char(2) // Estado de Origem
  city   String @db.VarChar(122) // Cidade de Origem
  code   Int // Código do processo
  year   Int // Ano do processo

  storage_key   String                   @unique @db.Uuid // Nome do arquivo no repositório
  hash          String                   @unique @db.VarChar(64) // SHA256
  status        DocumentStatus           @default(PENDING)
  deadline      DateTime? // Prazo para resposta
  search_vector Unsupported("tsvector")?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  user     User                      @relation(fields: [user_id], references: [id])
  content  DocumentContent?          @relation(fields: [content_id], references: [id])
  category DocumentCategory          @relation(fields: [category_id], references: [id])
  parent   Document?                 @relation("DocumentHierarchy", fields: [parent_id], references: [id])
  children Document[]                @relation("DocumentHierarchy")
  views    DocumentHistoryRelation[]
  keywords DocumentKeywordRelation[]

  @@unique([category_id, code, year, origin, state, city]) // RT 0001/2025 1ºDIP/Manaus/AM
  @@index([state, city, origin])
  @@index([status])
  @@index([search_vector], type: Gin)
  @@map("Documents")
}

model DocumentContent {
  id String @id @default(uuid()) @db.Uuid

  // Properties
  content String @db.Text

  // Relations
  documents Document?

  @@map("DocumentContents")
}

model DocumentCategory {
  id String @id @default(uuid()) @db.Uuid

  // Properties
  name         String  @unique @db.VarChar(122)
  acronym      String  @unique @db.VarChar(16)
  priority     Int     @default(0)
  need_content Boolean
  need_parent  Boolean

  // Relations
  documents Document[]

  @@map("DocumentCategories")
}

model DocumentHistoryRelation {
  user_id     String @db.Uuid
  document_id String @db.Uuid

  // Properties
  registers DateTime[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  user     User     @relation(fields: [user_id], references: [id])
  document Document @relation(fields: [document_id], references: [id])

  @@id([user_id, document_id])
  @@map("DocumentHistoryRelations")
}

model DocumentKeyword {
  id     String @id @default(uuid()) @db.Uuid
  tag_id String @db.Uuid

  // Properties
  key String @db.VarChar(60)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  documents DocumentKeywordRelation[]
  tags      KeywordTag                @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@unique([key, tag_id])
  @@index([key])
  @@map("DocumentKeywords")
}

model DocumentKeywordRelation {
  document_id String @db.Uuid
  keyword_id  String @db.Uuid

  // Properties
  ocurrences Int

  // Relations
  document Document        @relation(fields: [document_id], references: [id])
  keyword  DocumentKeyword @relation(fields: [keyword_id], references: [id], onDelete: Cascade)

  @@id([document_id, keyword_id])
  @@map("DocumentKeywordRelations")
}

model KeywordTag {
  id String @id @default(uuid()) @db.Uuid

  // Properties
  name String @unique @db.VarChar(60)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  keywords DocumentKeyword[]

  @@map("KeywordTags")
}
